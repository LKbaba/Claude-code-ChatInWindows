项目名称： Claude-code-ChatInWindows

当前版本： v2.0.2

升级时间： 2025-11-08

文档版本： 2.0

一、升级背景

当前问题
输入 `/` 会自动弹出命令框,但是命令框中的大部分命令无法正常工作（仅支持 6 个基本命令）

参考项目优势
UI 有明确的 `/` 按钮，用户主动点击触发
支持所有 23+ Claude CLI 命令
使用 `--resume` 参数保持会话连续性

项目定位
本项目是 Chat UI 插件，需要保持用户在聊天窗口内的持续对话体验，不应打断对话流程跳转到终端

二、升级目标

目标 1：改进 UI 交互
添加 `/` 按钮（样式与 `@` 按钮一致）
移除自动弹出逻辑，改为点击按钮触发

目标 2：增强命令功能
所有斜杠命令通过后台进程执行真实 Claude CLI（无头模式）
命令输出直接显示在聊天窗口中
支持会话恢复（使用 `--resume` 参数）
保持对话流程连续性，不打开终端窗口

目标 3：简化代码
删除内部命令模拟逻辑（约 108 行）
用统一的后台执行方式替代（约 60 行）
净减少代码约 50 行

三、技术方案

前端改动

| 改动点 | 说明 |
|--------|------|
| 添加 `/` 按钮 | 在 `@` 按钮旁边添加，样式一致 |
| 添加按钮样式 | `.slash-btn` 样式定义 |
| 移除自动监听 | 删除输入 `/` 自动弹出的逻辑 |
| 命令输出显示 | 在聊天窗口显示命令执行结果 |

后端改动

| 改动点 | 说明 |
|--------|------|
| 重写命令执行方法 | 从内部模拟改为后台进程执行 |
| 使用 child_process.spawn | 在后台执行 Claude CLI，不显示终端窗口 |
| 捕获命令输出 | 通过 stdout/stderr 捕获输出 |
| 输出显示到聊天窗口 | 将命令结果发送到 Webview 显示 |
| 添加会话恢复 | 使用 `--resume <session-id>` 参数 |
| 适配 Windows + Git Bash | 使用正确的 shell 配置和路径 |

核心技术实现

```typescript
// 使用后台进程执行命令（不打开终端窗口）
const process = cp.spawn('claude', [`/${command}`, '--resume', sessionId], {
    cwd: workspaceFolder,
    shell: true,
    stdio: ['pipe', 'pipe', 'pipe']  // 捕获输入输出
});

// 捕获输出并发送到聊天窗口
process.stdout?.on('data', (data) => {
    this._panel?.webview.postMessage({
        type: 'commandOutput',
        data: data.toString()
    });
});

// 命令完成后显示结果
process.on('close', (code) => {
    this._sendAndSaveMessage({
        type: 'output',
        data: `✅ 命令执行完成\n\n${output}`
    });
});
```

四、升级效果对比

升级前

```
用户输入 "/" → 自动弹出命令框 → 选择命令 → 大部分命令显示"不可用"
                                              ↓
                                        仅 6 个命令有内部实现
```

升级后

```
用户点击 "/" 按钮 → 弹出命令框 → 选择命令 → 后台执行真实 Claude CLI
                                           ↓
                                    输出显示在聊天窗口
                                           ↓
                                    所有 23+ 命令都可用
                                           ↓
                                    会话自动恢复（--resume）
                                           ↓
                                    对话流程不被打断
```

五、用户体验优势

✅ **对话流程连续** - 用户始终停留在聊天窗口，不需要切换到终端
✅ **操作简单** - 点击按钮选择命令，结果自动显示，无需额外操作
✅ **会话保持** - 使用 --resume 参数，命令执行后会话状态不丢失
✅ **功能完整** - 支持所有 23+ Claude CLI 官方命令
✅ **无头执行** - 后台执行，不打开终端窗口，不打断用户体验

六、风险与注意事项

风险 1：Claude CLI 路径问题
问题： Git Bash 可能找不到 `claude` 命令
解决： 确保 Claude CLI 已安装且在 PATH 中，启动时检测并提示

风险 2：输出捕获与显示
问题： 某些命令的输出可能包含特殊格式或 ANSI 转义码
解决： 对输出进行清理和格式化，确保在聊天窗口正确显示

风险 3：会话 ID 为空
问题： 新会话时没有 session ID
解决： 代码中已用 `if` 判断，无 session ID 时不添加 --resume 参数

风险 4：命令执行超时
问题： 某些命令可能执行时间较长
解决： 添加超时处理和进度提示，显示"命令执行中..."

七、测试要点

UI 测试
[ ] `/` 按钮显示正常，样式与 `@` 按钮一致
[ ] 点击按钮弹出命令框
[ ] 输入 `/` 不再自动弹出
[ ] 命令框显示所有可用命令

功能测试
[ ] 选择命令后**不打开终端窗口**
[ ] 命令在后台正确执行
[ ] 命令输出在聊天窗口中正确显示
[ ] 执行 `/help`、`/status`、`/cost`、`/doctor` 等命令
[ ] 有会话时正确添加 `--resume` 参数
[ ] 命令执行后会话保持，可以继续对话

输出显示测试
[ ] 命令输出格式正确（无乱码）
[ ] 多行输出正确显示
[ ] 错误信息正确显示（stderr）
[ ] 长输出不会卡顿 UI

会话连续性测试
[ ] 执行命令前后，对话历史保持
[ ] 执行命令后可以立即发送新消息
[ ] 不需要重新初始化会话

八、实施步骤

1. 修改 `getBodyContent.ts` 添加 `/` 按钮
2. 修改 `buttons.ts` 添加按钮样式
3. 修改 `ui-script.ts` 移除自动弹出逻辑，添加输出显示逻辑
4. 修改 `ClaudeChatProvider.ts` 重写命令执行方法（使用后台进程）
5. 本地测试所有功能
6. 验证对话流程不被打断

九、后续优化（可选）

在命令框中显示命令的描述信息
添加命令执行历史记录
支持自定义命令快捷键
优化命令输出的格式化显示（支持语法高亮、表格等）
添加命令执行进度指示器

文档结束
