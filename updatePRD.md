项目名称： Claude-code-ChatInWindows

当前版本： v2.0.2

升级时间： 2025-11-08

文档版本： 2.0

一、升级背景

当前问题
输入 `/` 会自动弹出命令框,但是命令框中的大部分命令无法正常工作（仅支持 6 个基本命令）

参考项目优势
UI 有明确的 `/` 按钮，用户主动点击触发
支持所有 23+ Claude CLI 命令
使用 `--resume` 参数保持会话连续性

项目定位
本项目是 Chat UI 插件，本次更新主要是优化斜杠命令功能以及部分UI交互体验。

二、升级目标

目标 1：改进 UI 交互
添加 `/` 按钮（在 `@` 按钮左边，样式与 `@` 按钮一致）
移除自动弹出逻辑，改为点击按钮触发

目标 2：增强命令功能
所有斜杠命令通过终端执行真实 Claude CLI
支持所有 23+ Claude CLI 官方命令
支持会话恢复（使用 `--resume` 参数）
命令在独立终端窗口中执行，输出直接可见
用户查看输出后可快速返回聊天窗口

目标 3：简化代码
删除内部命令模拟逻辑（约 108 行）
用统一的终端执行方式替代（约 30 行）
净减少代码约 80 行

三、技术方案

前端改动

| 改动点 | 说明 |
|--------|------|
| 添加 `/` 按钮 | 在 `@` 按钮左边添加，样式一致 |
| 添加按钮样式 | `.slash-btn` 样式定义 |
| 移除自动监听 | 删除输入 `/` 自动弹出的逻辑 |
| 终端提示显示 | 在聊天窗口显示"命令正在终端中执行"提示 |

后端改动

| 改动点 | 说明 |
|--------|------|
| 重写命令执行方法 | 从内部模拟改为终端执行 |
| 使用 vscode.window.createTerminal | 创建 VS Code 终端窗口 |
| 使用 terminal.sendText | 发送 Claude CLI 命令到终端 |
| 显示终端窗口 | 使用 terminal.show() 显示终端 |
| 添加会话恢复 | 使用 `--resume <session-id>` 参数 |
| 提示消息 | 在聊天窗口提示用户查看终端 |
| 适配 Windows + Git Bash | 使用正确的 shell 配置和路径 |

核心技术实现

```typescript
// 构建命令参数
private _executeSlashCommand(command: string): void {
    const args = [`/${command}`];

    // 添加会话恢复参数
    if (this._currentSessionId) {
        args.push('--resume', this._currentSessionId);
    }

    // 创建终端窗口并执行命令
    const terminal = vscode.window.createTerminal(`Claude /${command}`);
    terminal.sendText(`claude ${args.join(' ')}`);
    terminal.show();

    // 在聊天窗口提示用户
    this._sendAndSaveMessage({
        type: 'info',
        data: `⚡ 正在终端中执行 \`/${command}\` 命令...\n\n请查看终端窗口获取输出。${this._currentSessionId ? '\n✅ 会话将自动恢复' : ''}\n\n查看完毕后，可以回到此聊天窗口继续对话。`
    });
}
```

四、升级效果对比

升级前

```
用户输入 "/" → 自动弹出命令框 → 选择命令 → 大部分命令显示"不可用"
                                              ↓
                                        仅 6 个命令有内部实现
```

升级后

```
用户点击 "/" 按钮 → 弹出命令框 → 选择命令 → 在终端窗口执行真实 Claude CLI
                                           ↓
                                    聊天窗口显示提示信息
                                           ↓
                                    终端窗口显示命令输出
                                           ↓
                                    所有 23+ 命令都可用
                                           ↓
                                    会话自动恢复（--resume）
                                           ↓
                                    查看完毕后可快速返回聊天窗口
```

五、用户体验优势

✅ **图形化操作** - 通过点击按钮和选择菜单，避免手动输入命令
✅ **操作简单** - 点击 "/" 按钮选择命令，自动在终端执行
✅ **会话保持** - 使用 --resume 参数，命令执行后会话状态不丢失
✅ **功能完整** - 支持所有 23+ Claude CLI 官方命令
✅ **快速切换** - 终端窗口查看输出后，可立即返回聊天窗口继续对话
✅ **输出可见** - 命令输出直接在终端窗口显示，格式完整，支持交互
✅ **提示友好** - 聊天窗口显示清晰的提示信息，告知用户操作步骤

六、风险与注意事项

风险 1：Claude CLI 路径问题
问题： Git Bash 可能找不到 `claude` 命令
解决： 确保 Claude CLI 已安装且在 PATH 中，启动时检测并提示

风险 2：会话 ID 为空
问题： 新会话时没有 session ID
解决： 代码中已用 `if` 判断，无 session ID 时不添加 --resume 参数

风险 3：用户体验调整
问题： 命令执行时会短暂切换到终端窗口
解决： 在聊天窗口显示清晰的提示信息，告知用户查看终端并可快速返回

风险 4：终端窗口管理
问题： 频繁执行命令可能产生多个终端窗口
解决： 每个命令使用独立命名的终端窗口，用户可以关闭不需要的终端

七、测试要点

UI 测试
[ ] `/` 按钮显示正常，样式与 `@` 按钮一致
[ ] 点击按钮弹出命令框
[ ] 输入 `/` 不再自动弹出
[ ] 命令框显示所有可用命令

功能测试
[ ] 选择命令后**打开终端窗口**
[ ] 命令在终端中正确执行
[ ] 聊天窗口显示提示信息
[ ] 终端窗口显示命令输出
[ ] 执行 `/help`、`/status`、`/cost`、`/doctor` 等命令
[ ] 有会话时正确添加 `--resume` 参数
[ ] 命令执行后会话保持，可以继续对话

终端显示测试
[ ] 终端窗口名称正确（如 "Claude /help"）
[ ] 命令输出格式正确（保留 ANSI 颜色等）
[ ] 多行输出正确显示
[ ] 错误信息正确显示（stderr）
[ ] 交互式命令可以正常工作

会话连续性测试
[ ] 执行命令前后，对话历史保持
[ ] 从终端返回聊天窗口后可以立即发送新消息
[ ] 不需要重新初始化会话
[ ] 提示消息显示会话恢复状态

八、实施步骤

1. 修改 `getBodyContent.ts` 添加 `/` 按钮（在 `@` 按钮左边）
2. 修改 `buttons.ts` 添加按钮样式
3. 修改 `ui-script.ts` 移除自动弹出逻辑
4. 修改 `ClaudeChatProvider.ts` 重写命令执行方法（使用终端窗口）
5. 本地测试所有功能
6. 验证会话保持和提示信息显示

文档结束
